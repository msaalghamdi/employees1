<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نظام تقارير التوطين</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; margin: 20px; direction: rtl; }
    .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h2 { color: #1a73e8; text-align: center; border-bottom: 2px solid #e8eaed; padding-bottom: 15px; }
    .input-group { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .input-field { flex: 1; min-width: 250px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; color: #3c4043; }
    input[type="text"] { width: 100%; padding: 10px; border: 1px solid #dadce0; border-radius: 6px; box-sizing: border-box; }
    .indicator-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f1f3f4; transition: background 0.2s; }
    .indicator-row:hover { background: #f8f9fa; }
    .num { width: 45px; font-weight: bold; color: #70757a; }
    .desc { flex: 1; font-size: 14px; line-height: 1.5; color: #202124; }
    .weight { width: 70px; font-weight: bold; color: #d93025; text-align: center; }
    .checkbox { width: 18px; height: 18px; margin-right: 15px; cursor: pointer; }
    .total-box { background: #e6f4ea; padding: 15px; border-radius: 8px; margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
    .total-text { font-size: 18px; font-weight: bold; color: #137333; }
    button { background: #1a73e8; color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 6px; cursor: pointer; display: block; margin: 25px auto; transition: background 0.3s; }
    button:hover { background: #1557b0; }
  </style>
</head>
<body>

<div class="container">
  <h2>توليد تقرير التوطين الوهمي</h2>

  <div class="input-group">
    <div class="input-field">
      <label>اسم الموظف</label>
      <input type="text" id="empName" placeholder="مثال: محمد عبدالله">
    </div>
    <div class="input-field">
      <label>رقم الهوية</label>
      <input type="text" id="idNumber" placeholder="10xxxxxxxx">
    </div>
  </div>

  <div id="indicatorsList"></div>

  <div class="total-box">
    <span>النتيجة الإجمالية للمؤشرات:</span>
    <span class="total-text"><span id="totalPercent">0</span>%</span>
  </div>

  <button onclick="generateExcel()">تصدير ملف Excel باسم الموظف</button>
</div>

<script>
  const indicators = [
    { num: "1", desc: "عدم وجود عقد عمل موثق", weight: 10 },
    { num: "2", desc: "عدم وجود تأمين طبي للعامل", weight: 20 },
    { num: "3", desc: "عدم وجود إجابات صحيحة بشأن موقع وطبيعة العمل", weight: 60 },
    { num: "4", desc: "إقرار العامل أو المنشأة بعدم وجود علاقة عمل فعلية", weight: 80 },
    { num: "5", desc: "عدم دفع الأجر من خلال برنامج حماية الأجور", weight: 30 },
    { num: "6", desc: "وجود صلة قرابة بين العامل وصاحب العمل", weight: 10 },
    { num: "7", desc: "عدم تسجيل العامل في منصة العمل عن بعد", weight: 50 },
    { num: "8", desc: "وجود تبرير لعدم صرف الأجر لمدة 3 أشهر فأكثر", weight: 30 },
    { num: "9", desc: "عدم تسكين الموظف على المنشأة المسجل عليها", weight: 10 },
    { num: "10", desc: "توظيف فئات لا تتناسب مهنهم مع قدراتهم", weight: 60 },
    { num: "11", desc: "وجود سابقة توطين وهمي للمنشأة أو العامل", weight: 20 },
    { num: "12", desc: "عدم وجود موقع للمنشأة أو عدم تحديث بياناتها", weight: 50 }
  ];

  function render() {
    document.getElementById('indicatorsList').innerHTML = indicators.map((ind, i) => `
      <div class="indicator-row">
        <div class="num">${ind.num}</div>
        <div class="desc">${ind.desc}</div>
        <div class="weight">${ind.weight}%</div>
        <input type="checkbox" id="chk${i}" class="checkbox" data-weight="${ind.weight}" onchange="updateTotal()">
      </div>
    `).join('');
  }

  function updateTotal() {
    let total = 0;
    document.querySelectorAll('.checkbox:checked').forEach(cb => total += parseFloat(cb.dataset.weight));
    document.getElementById('totalPercent').textContent = total;
  }

  function generateExcel() {
    const name = document.getElementById('empName').value.trim() || "تقرير_عام";
    const idNum = document.getElementById('idNumber').value || "غير مسجل";
    const totalScore = document.getElementById('totalPercent').textContent;

    // بناء مصفوفة البيانات بتنسيق جدولي
    const ws_data = [
      ["تقرير نتائج مؤشرات التوطين الوهمي"],
      [""],
      ["بيانات الموظف"],
      ["اسم الموظف:", name, "", "رقم الهوية:", idNum],
      ["تاريخ الاستخراج:", new Date().toLocaleDateString('ar-SA')],
      [""],
      ["م", "المؤشر", "الوزن النسبي", "تم التحقق", "النتيجة"],
    ];

    indicators.forEach((ind, i) => {
      const isChecked = document.getElementById(`chk${i}`).checked;
      ws_data.push([
        ind.num,
        ind.desc,
        ind.weight + "%",
        isChecked ? "نعم" : "لا",
        isChecked ? ind.weight + "%" : "0%"
      ]);
    });

    ws_data.push(["", "الإجمالي النهائي", "", "", totalScore + "%"]);

    const ws = XLSX.utils.aoa_to_sheet(ws_data);

    // إعدادات عرض الأعمدة ليكون شكل الملف مرتباً
    ws['!cols'] = [
      { wch: 5 },  // م
      { wch: 50 }, // المؤشر
      { wch: 15 }, // الوزن
      { wch: 12 }, // تم التحقق
      { wch: 12 }  // النتيجة
    ];

    // دمج خلية العنوان الرئيسي
    ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "التقرير");
    
    // حفظ الملف باسم الموظف
    XLSX.writeFile(wb, `${name}.xlsx`);
  }

  render();
</script>

</body>
</html>
