<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نظام تقارير التوطين 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; margin: 20px; direction: rtl; }
    .container { max-width: 950px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
    h2 { color: #2c3e50; text-align: center; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
    .info-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; background: #fcfcfc; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
    label { font-weight: bold; color: #34495e; margin-bottom: 8px; display: block; }
    input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
    .indicator-header { display: flex; background: #34495e; color: white; padding: 10px; border-radius: 5px; font-weight: bold; margin-bottom: 10px; }
    .indicator-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; transition: 0.2s; }
    .indicator-row:hover { background: #f9f9f9; }
    .col-num { width: 50px; text-align: center; }
    .col-desc { flex: 1; padding: 0 15px; font-size: 14px; }
    .col-weight { width: 80px; text-align: center; font-weight: bold; color: #e74c3c; }
    .col-check { width: 50px; text-align: center; }
    .total-footer { margin-top: 25px; padding: 15px; background: #27ae60; color: white; border-radius: 8px; display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; }
    button { background: #3498db; color: white; border: none; padding: 15px 40px; font-size: 18px; border-radius: 8px; cursor: pointer; display: block; margin: 30px auto; width: 100%; max-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    button:hover { background: #2980b9; transform: translateY(-2px); }
  </style>
</head>
<body>

<div class="container">
  <h2>جدول المؤشرات والأوزان الاسترشادية للمراقب</h2>

  <div class="info-section">
    <div>
      <label>اسم الموظف المستهدف:</label>
      <input type="text" id="empName" placeholder="أدخل الاسم الرباعي">
    </div>
    <div>
      <label>رقم الهوية الوطنية:</label>
      <input type="text" id="idNumber" placeholder="10xxxxxxxx">
    </div>
  </div>

  <div class="indicator-header">
    <div class="col-num">#</div>
    <div class="col-desc">المؤشر</div>
    <div class="col-weight">الوزن</div>
    <div class="col-check">تحديد</div>
  </div>

  <div id="indicatorsContainer"></div>

  <div class="total-footer">
    <span>إجمالي النتيجة الاسترشادية:</span>
    <span id="displayTotal">0%</span>
  </div>

  <button onclick="exportToExcel()">توليد تقرير Excel</button>
</div>

<script>
  const indicatorsData = [
    { n: "1", d: "عدم وجود عقد عمل موثق", w: 10 },
    { n: "2", d: "عدم وجود تأمين طبي للعامل", w: 20 },
    { n: "3-أ", d: "عدم صحة الإجابات بشأن: موقع العمل", w: 20 },
    { n: "3-ب", d: "عدم صحة الإجابات بشأن: طبيعة العمل", w: 30 },
    { n: "3-ج", d: "عدم صحة الإجابات بشأن: نشاط المنشأة", w: 10 },
    { n: "4", d: "إقرار العامل أو المنشأة بعدم وجود علاقة عمل فعلية", w: 80 },
    { n: "5", d: "عدم دفع الأجر من خلال برنامج حماية الأجور", w: 30 },
    { n: "6", d: "وجود صلة قرابة بين العامل وصاحب العمل", w: 10 },
    { n: "7", d: "عدم تسجيل العامل في منصة العمل عن بعد (عند الادعاء بذلك)", w: 50 },
    { n: "8", d: "تبرير المنشأة لعدم صرف الأجر لمدة 3 أشهر فأكثر دون اعتراض العامل", w: 30 },
    { n: "9", d: "عدم تسكين الموظف على المنشأة المسجل عليها", w: 10 },
    { n: "10", d: "توظيف نساء/كبار سن/ذوي إعاقة بمهنة لا تتوافق مع قدراتهم", w: 60 },
    { n: "11", d: "وجود سابقة لدى العامل أو المنشأة في التوطين الوهمي", w: 20 },
    { n: "12", d: "عدم وجود موقع للمنشأة أو عدم تحديث البيانات", w: 50 }
  ];

  function init() {
    const container = document.getElementById('indicatorsContainer');
    container.innerHTML = indicatorsData.map((ind, i) => `
      <div class="indicator-row">
        <div class="col-num">${ind.n}</div>
        <div class="col-desc">${ind.d}</div>
        <div class="col-weight">${ind.w}%</div>
        <div class="col-check">
          <input type="checkbox" class="chk" data-weight="${ind.w}" onchange="calc()">
        </div>
      </div>
    `).join('');
  }

  function calc() {
    let sum = 0;
    document.querySelectorAll('.chk:checked').forEach(c => sum += parseInt(c.dataset.weight));
    document.getElementById('displayTotal').innerText = sum + "%";
  }

  function exportToExcel() {
    const name = document.getElementById('empName').value.trim() || "موظف غير معروف";
    const id = document.getElementById('idNumber').value.trim() || "-";
    const total = document.getElementById('displayTotal').innerText;

    // بناء مصفوفة البيانات بتنسيق احترافي
    const rows = [
      ["جدول المؤشرات والأوزان الاسترشادية للمراقب - 2025"],
      [""],
      ["بيانات الموظف"],
      ["اسم الموظف:", name, "", "رقم الهوية:", id],
      ["تاريخ التقرير:", new Date().toLocaleDateString('ar-SA')],
      [""],
      ["#", "المؤشر", "الوزن النسبي", "تم التحقق", "النتيجة"]
    ];

    indicatorsData.forEach((ind, i) => {
      const checked = document.querySelectorAll('.chk')[i].checked;
      rows.push([
        ind.n,
        ind.d,
        ind.w + "%",
        checked ? "نعم" : "لا",
        checked ? ind.w + "%" : "0%"
      ]);
    });

    rows.push(["", "المجموع الإجمالي", "", "", total]);

    const ws = XLSX.utils.aoa_to_sheet(rows);

    // ضبط عرض الأعمدة (Columns Width)
    ws['!cols'] = [
      { wch: 8 },  // م
      { wch: 65 }, // المؤشر (عرض كبير للنص)
      { wch: 15 }, // الوزن
      { wch: 12 }, // نعم/لا
      { wch: 12 }  // النتيجة
    ];

    // دمج خلايا العنوان الرئيسي (Merge Cells)
    ws['!merges'] = [
      { s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }, // العنوان
      { s: { r: 2, c: 0 }, e: { r: 2, c: 4 } }  // بيانات الموظف
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "تقرير التوطين");
    
    // تصدير الملف باسم الموظف
    XLSX.writeFile(wb, `${name}.xlsx`);
  }

  init();
</script>

</body>
</html>
